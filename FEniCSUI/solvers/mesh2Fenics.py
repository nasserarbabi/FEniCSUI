import fenics as fn
import numpy as np
import json
from collections import namedtuple

#__author__ = "Nasser Arbabi"
#__maintainer__ = "Nasser Arbabi"
#__email__ = "nasser@composites.ubc.ca"


def meshReader(dictMesh):
    ''' converts json mesh to fenics mesh and apply the boundary conditions.
    dict:: dictMesh,  the mesh from database in the form of a python dictionary

    output:
    dolfin.ccp.mesh:: feMesh, mesh defined in fenics object
    '''

    # conver dict to object
    mesh = namedtuple("mesh", dictMesh.keys())(*dictMesh.values())

    nodes = np.array(mesh.nodes)
    cells = np.array(mesh.connectivity, dtype=np.uintp)

    feMesh = fn.Mesh()
    
    editor = fn.MeshEditor()
    # cell type, topological, and geometrical dimensions. i.e. 2, 3 for 3d surface mesh
    editor.open(feMesh, "triangle", 2, 3)
    # cell types available:  point, interval, triangle, quadrilateral, tetrahedron, hexahedron
    editor.init_vertices(len(mesh.nodes))
    editor.init_cells(len(mesh.connectivity))

    [editor.add_vertex(i, n) for i, n in enumerate(nodes)]
    [editor.add_cell(i, n-1) for i, n in enumerate(cells)]
    editor.close()

    # construct faces
    faceSets = fn.MeshFunction('size_t', feMesh, 2)
    for face, faceCells in mesh.faces.items():
        for index in faceCells:
            faceSets.set_value(index, int(face), feMesh)
    
    # construct edges
    edgeSets = fn.MeshFunction('size_t', feMesh,1)
    meshEdges = {}
    for edge in fn.edges(feMesh):     
        meshEdges[edge.index()]=[]
        for vert in fn.vertices(edge):
            meshEdges[edge.index()].append(vert.index())

    for edge, nodes in meshEdges.items():
        for edgeName, edgeList in mesh.edges.items():
            if nodes in edgeList:
                edgeSets.set_value(edge, int(edgeName), feMesh)

    # construct points
    pointSets = fn.MeshFunction('size_t', feMesh, 0)
    for pointName, point in mesh.points.items():
        pointSets.set_value(point, int(pointName), feMesh)

    return dict(feMesh=feMesh, faceSets=faceSets, edgeSets=edgeSets, pointSets=pointSets)


if __name__ == "__main__":
    mesh = "{\"nodes\": [[0.0, 0.0, 0.0], [0.0127, 0.0, 0.0], [0.0127, -0.0127, 0.0], [0.0, -0.0127, 0.0], [0.0127, -0.0254, 0.0], [0.0, -0.0254, 0.0], [0.0253979451954365, -0.0127, 0.0], [0.0253979451954365, -0.0254, 0.0], [0.0253979451954365, 0.0, 0.0], [0.006349999999999994, 0.0, 0.0], [0.0127, -0.006349999999999987, 0.0], [0.006350000000000014, -0.0127, 0.0], [0.0, -0.006349999999999987, 0.0], [0.0127, -0.01904999999999999, 0.0], [0.006349999999999994, -0.0254, 0.0], [0.0, -0.01904999999999999, 0.0], [0.01904897259771824, -0.0127, 0.0], [0.0253979451954365, -0.01904999999999999, 0.0], [0.019048972597718268, -0.0254, 0.0], [0.019048972597718268, 0.0, 0.0], [0.0253979451954365, -0.006349999999999987, 0.0], [0.00635, -0.006349999999999996, 0.0], [0.009525000000000006, -0.009524999999999994, 0.0], [0.009524999999999997, -0.0031749999999999942, 0.0], [0.0031749999999999973, -0.0031749999999999934, 0.0], [0.003175000000000002, -0.009524999999999995, 0.0], [0.0063500000000000015, -0.01904999999999999, 0.0], [0.009524999999999997, -0.022225, 0.0], [0.0031750000000000038, -0.01587499999999999, 0.0], [0.0031749999999999973, -0.022225, 0.0], [0.009525000000000006, -0.01587499999999999, 0.0], [0.01904897259771825, -0.01905102731916715, 0.0], [0.02222345889657737, -0.01587499999999999, 0.0], [0.015874486298859118, -0.01587499999999999, 0.0], [0.01904897259771825, -0.006348972680832854, 0.0], [0.02222345889657737, -0.009524999999999994, 0.0], [0.015874486298859118, -0.009524999999999992, 0.0]], \"connectivity\": [[3, 23, 11], [2, 24, 10], [4, 26, 12], [11, 23, 22], [12, 22, 23], [4, 13, 26], [13, 25, 22], [11, 22, 24], [12, 26, 22], [13, 22, 26], [10, 22, 25], [10, 24, 22], [1, 10, 25], [3, 12, 23], [1, 25, 13], [2, 11, 24], [4, 12, 29], [6, 16, 30], [27, 28, 30], [5, 28, 14], [16, 29, 27], [16, 27, 30], [14, 27, 31], [14, 28, 27], [5, 15, 28], [15, 30, 28], [3, 31, 12], [6, 30, 15], [3, 14, 31], [4, 29, 16], [12, 27, 29], [12, 31, 27], [8, 19, 32], [5, 32, 19], [8, 32, 18], [5, 14, 32], [3, 34, 14], [7, 18, 33], [7, 33, 17], [3, 17, 34], [17, 33, 34], [32, 34, 33], [14, 34, 32], [18, 32, 33], [9, 35, 20], [2, 20, 35], [9, 21, 35], [2, 35, 11], [3, 11, 37], [7, 36, 21], [7, 17, 36], [3, 37, 17], [17, 37, 36], [35, 36, 37], [11, 35, 37], [21, 36, 35]], \"faces\": {\"1\": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], \"2\": [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31], \"3\": [32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43], \"4\": [44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55]}, \"edges\": {\"1\": [[0, 9], [1, 9]], \"2\": [[1, 10], [2, 10]], \"3\": [[2, 11], [3, 11]], \"4\": [[0, 12], [3, 12]], \"5\": [[2, 13], [4, 13]], \"6\": [[5, 14], [4, 14]], \"7\": [[3, 15], [5, 15]], \"8\": [[6, 16], [2, 16]], \"9\": [[6, 17], [7, 17]], \"10\": [[4, 18], [7, 18]], \"11\": [[1, 19], [8, 19]], \"12\": [[8, 20], [6, 20]]}, \"points\": {\"1\": 1, \"2\": 2, \"3\": 3, \"4\": 4, \"5\": 5, \"6\": 6, \"7\": 7, \"8\": 8, \"9\": 9}}"
    # mesh = "{\"nodes\": [[0.0, -0.0254, 0.0], [0.0253979451954365, -0.0254, 0.0], [0.0, 0.0, 0.0], [0.0253979451954365, 0.0, 0.0], [0.01269897259771825, -0.0127, 0.0]], \"connectivity\": [[1, 3, 5], [2, 5, 4], [1, 5, 2], [3, 4, 5]], \"faces\": {\"1\": [0, 1, 2, 3]}, \"edges\": {\"1\": [[0, 1]], \"2\": [[2, 0]], \"3\": [[2, 3]], \"4\": [[3, 1]]}, \"points\": {\"1\": 1, \"2\": 2, \"3\": 3, \"4\": 4}}"
    # mesh="{\"nodes\": [[0.0, -0.0254, 0.0], [0.0253979451954365, -0.0254, 0.0], [0.0, 0.0, 0.0], [0.0253979451954365, 0.0, 0.0], [0.006349486298859123, -0.0254, 0.0], [0.01269897259771825, -0.0254, 0.0], [0.01904845889657738, -0.0254, 0.0], [0.0, -0.006349999999999995, 0.0], [0.0, -0.012699999999999972, 0.0], [0.0, -0.01904999999999998, 0.0], [0.006349486298859123, 0.0, 0.0], [0.01269897259771825, 0.0, 0.0], [0.01904845889657738, 0.0, 0.0], [0.0253979451954365, -0.006349999999999995, 0.0], [0.0253979451954365, -0.012699999999999972, 0.0], [0.0253979451954365, -0.01904999999999998, 0.0], [0.01269897259771825, -0.01270015610446156, 0.0], [0.01798958326697118, -0.007408276288516567, 0.0], [0.007408361928465312, -0.0074082762885165675, 0.0], [0.01799015410604435, -0.017992294504376973, 0.0], [0.007407791089392147, -0.017992294504376973, 0.0], [0.019803715848823247, -0.012700187568305139, 0.0], [0.005594229346613247, -0.012700187568305139, 0.0], [0.01269897259771825, -0.019806452678707242, 0.0], [0.01269897259771825, -0.005593279434587903, 0.0], [0.021296937380298128, -0.004101189732918962, 0.0], [0.00410100781513837, -0.004101189732918961, 0.0], [0.02129738334832279, -0.02129925619902786, 0.0], [0.004100561847113706, -0.02129925619902786, 0.0]], \"connectivity\": [[14, 22, 18], [8, 19, 23], [10, 23, 21], [16, 20, 22], [13, 18, 25], [11, 25, 19], [7, 24, 20], [5, 21, 24], [8, 23, 9], [14, 15, 22], [15, 16, 22], [9, 23, 10], [6, 24, 7], [5, 24, 6], [12, 13, 25], [11, 12, 25], [17, 19, 25], [17, 25, 18], [17, 18, 22], [17, 23, 19], [17, 24, 21], [17, 20, 24], [17, 21, 23], [17, 22, 20], [13, 26, 18], [11, 19, 27], [14, 18, 26], [8, 27, 19], [7, 20, 28], [5, 29, 21], [16, 28, 20], [10, 21, 29], [4, 14, 26], [3, 27, 8], [4, 26, 13], [3, 11, 27], [2, 28, 16], [1, 10, 29], [1, 29, 5], [2, 7, 28]], \"faces\": {\"1\": [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39]}, \"edges\": {\"1\": [[0, 4], [4, 5], [5, 6], [1, 6]], \"2\": [[2, 7], [7, 8], [8, 9], [0, 9]], \"3\": [[2, 10], [10, 11], [11, 12], [3, 12]], \"4\": [[3, 13], [13, 14], [14, 15], [1, 15]]}, \"points\": {\"1\": 1, \"2\": 2, \"3\": 3, \"4\": 4}}"

    feMesh = meshReader(mesh)
